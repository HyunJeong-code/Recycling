<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="recycling.manager.dao.face.CsDao">

	<!-- 문의 sql 아이디 -->
	<sql id="selectOtoList">
		SELECT
			oto_code, ct_otono, b_code, oto_title, oto_content, oto_name, oto_email, oto_date, oto_hit
		FROM OTO
	</sql>
	
	<!-- 구매자 sql 아이디 -->
	<sql id="selectBuyerList">
		SELECT * FROM BUYER
	</sql>
	
	<!-- 문의글 목록 -->
	<select id="list" resultType="Oto">
		SELECT * FROM (
			SELECT rownum rnum, B.* FROM (
				<include refid="selectOtoList" />
				ORDER BY oto_code DESC
			) B
		)
		<where>
			AND rnum BETWEEN #{startNo } AND #{endNo }
		</where>
	</select>
	
<<<<<<< HEAD
	<!-- 페이징 -->
	<select id="getPaging" resultType="int" parameterType="recycling.util.PagingAndCtg">
		SELECT count(*) FROM(
			<include refid="selectAll"/>
			<include refid="selectBuyerList"/>
		)
=======
	<!-- 문의글 페이징 -->
	<select id="selectCntAllotoList" resultType="int" parameterType="recycling.util.PagingAndCtg">
   		SELECT count(*)
   			FROM(
		   		<include refid="selectOtoList"/>
   			)
		<where>
			AND (
				oto_code LIKE '%' || #{search } || '%'
				OR oto_name LIKE '%' || #{search } || '%'
				)
		</where>
		ORDER BY oto_code DESC
>>>>>>> TEST
	</select>
	
	<!-- 구매자 목록 -->
	<select id="buyerList" resultType="Buyer">
		SELECT * FROM (
			SELECT rownum rnum, B.* FROM (
				<include refid="selectBuyerList" />
				ORDER BY b_code DESC
			) B
		)
		<where>
			AND rnum BETWEEN #{startNo } AND #{endNo }
		</where>
	</select>
	
	<!-- 구매자 상세조회 -->
	<select id="buyerDetail" resultType="Buyer" parameterType="Buyer">
		<include refid="selectBuyerList" />
		<where>B_CODE = #{bCode}</where>
	</select>
	
	<!-- 구매자 페이징 -->
	<select id="selectCntAllbuyerList" resultType="int" parameterType="recycling.util.PagingAndCtg">
   		SELECT count(*)
   			FROM(
		   		<include refid="selectBuyerList"/>
   			)
		<where>
			AND (
				b_code LIKE '%' || #{search } || '%'
				OR b_name LIKE '%' || #{search } || '%'
				)
		</where>
		ORDER BY b_code DESC
	</select>

	<!-- 구매자 수정 -->	
	<update id="buyerUpdate" parameterType="Buyer">
		UPDATE BUYER
		SET b_name = #{bName },
			b_phone = #{bPhone },
			b_email = #{bEmail }
		<where>
			AND b_code = #{bCode }
		</where>
	</update>
	
	<!-- 구매자 삭제 -->
	<update id="buyerDel" parameterType="Buyer">
		UPDATE BUYER
			SET B_OUT = 'Y'			
			, B_OUT_DATE = sysdate			
		<where>
			AND b_code = #{bCode }
		</where>
	</update>
	
	<!-- 문의글 상세조회 -->
	<select id="ansForm" resultType="Oto" parameterType="Oto">
		<include refid="selectOtoList" />
		<where>OTO_CODE = #{otoCode }</where>
	</select>
	
	<!-- 문의글 답변 -->
	<insert id="ansFormInsert" parameterType="Ans">
		<selectKey order="BEFORE" keyProperty="ansCode" resultType="String">
			SELECT 'ANS' || LPAD(qna_seq.nextval, 7, '0') FROM dual
		</selectKey>
		INSERT INTO ANS (ANS_CODE, OTO_CODE, MGR_CODE, ANS_CONTENT, ANS_DATE)
		VALUES(#{ansCode }, #{otoCode }, #{mgrCode }, #{ansContent }, sysdate)
	</insert>
	
	<!-- 문의글 삭제 -->
	<delete id="otoDel" parameterType="String">
	    DELETE FROM oto
	    <where>
	        oto_code = #{otoCode }
	    </where>
	</delete>
	
	<!-- 답글 리스트 -->
	<select id="viewCom" parameterType="String" resultType="Ans">
		SELECT ANS_CODE, OTO_CODE, MGR_CODE, ANS_CONTENT, ANS_DATE
		FROM ANS
		<where>
			OTO_CODE = #{otoCode }
		</where>		
		ORDER BY ANS_DATE DESC
	</select>
	
</mapper>
