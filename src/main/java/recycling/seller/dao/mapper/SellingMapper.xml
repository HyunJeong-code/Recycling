<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="recycling.seller.dao.face.SellingDao">

	<sql id="selectExp">
	SELECT * FROM Exp
	</sql>
	
	<select id="selectAllrcyPrd" parameterType="String" resultType="Prd">
		SELECT * FROM prd
		<where>
			AND s_code = #{sCode}
			AND ct_pno = 0
		</where>
		ORDER BY prd_code DESC
	</select>
	
	<select id="selectAllupcyPrd" parameterType="recycling.util.PagingAndCtg" resultType="Prd">
		SELECT *
		FROM (
			SELECT rownum no, PRD.* FROM (
				SELECT * FROM prd
				<where>
					AND s_code = #{user }
					AND ct_pno = 1
					AND (
					prd_name LIKE '%' || #{search } || '%'
					OR prd_detail LIKE '%' || #{search } || '%'
					)
				</where>
				ORDER BY prd_code DESC
			) PRD
		)
		<where>
			AND no BETWEEN #{startNo } AND #{endNo }
		</where>
	</select>
	
	<select id="selectAllMyOrder" parameterType="String" resultType="MyOrder">
		SELECT 
			od.ORDDT_CODE, od.ORD_CODE, PRD_CODE, od.ORD_NAME, o.SEND_NAME
			, o.SEND_PHONE, o.ORD_POSTCODE, o.ORD_ADDR, o.ORD_DETAIL, o.ORD_MEMO
			, ORD_PRICE, ORD_CNT, od.ORD_SUM, STT_NO, ORD_DATE, SHIP_NAME, SHIP_NO
		FROM 
			order_detail od, orders o, ship s
		<where>
			AND od.ord_code = o.ord_code
			AND od.orddt_code = s.orddt_code(+)
			AND od.prd_code = #{prdCode}
		</where>
		ORDER BY od.ORDDT_CODE DESC
	</select>
	
	<update id="deletePrd" parameterType="String">
		UPDATE prd
		SET prd_out = 'Y',
			prd_cnt = 0
		<where>
			prd_code = #{prdCode}
		</where>
	</update>
	
	<select id="selectByprdCode" parameterType="String" resultType="Prd">
		SELECT * FROM prd
		<where>
			prd_code = #{prdCode}
		</where>
	</select>
	
	<update id="updatePrd" parameterType="Prd">
		UPDATE prd
		SET ct_pdtno = #{ctPdtNo},
			prd_name = #{prdName},
			price = #{price},
			prd_cnt = #{prdCnt},
			prd_detail = #{prdDetail}
		<where>
			prd_code = #{prdCode}
		</where>
	</update>
	
	<select id="selectByorddtCode" parameterType="String" resultType="OrderDetail">
		SELECT * FROM order_detail
		<where>
			AND orddt_code = #{orddtCode}
		</where>
	</select>
	
	<update id="updateOrderDetail" parameterType="OrderDetail">
		UPDATE order_detail
		SET stt_no = #{sttNo}
		<where>
			AND orddt_code = #{orddtCode}
		</where>
	</update>
	
	<insert id="insertShip" parameterType="MyOrder">
		INSERT INTO ship
		VALUES ('SHIP' || LPAD(qst_seq.nextval, 6, '0'), #{orddtCode}, #{shipName}, #{shipNo}, sysdate)
	</insert>
	
	<delete id="deleteShip" parameterType="String">
		DELETE FROM ship
		<where>
			AND orddt_code = #{orddtCode}
		</where>
	</delete>
	
	<select id="selectMyOrderByOrddtCode" parameterType="String" resultType="MyOrder">
		SELECT 
			od.ORDDT_CODE, od.ORD_CODE, PRD_CODE, od.ORD_NAME, o.SEND_NAME
			, o.SEND_PHONE, o.ORD_POSTCODE, o.ORD_ADDR, o.ORD_DETAIL, o.ORD_MEMO
			, ORD_PRICE, ORD_CNT, od.ORD_SUM, STT_NO, ORD_DATE, SHIP_NAME, SHIP_NO
		FROM 
			order_detail od, orders o, ship s
		<where>
			AND od.ord_code = o.ord_code
			AND od.orddt_code = s.orddt_code(+)
			AND od.orddt_code = #{orddtCode}
		</where>
		ORDER BY od.ORDDT_CODE DESC
	</select>
	
	<update id="updateMyOrder" parameterType="MyOrder">
		UPDATE
			orders
		SET
			send_name = #{sendName}
			, send_phone = #{sendPhone}
			, ord_postcode = #{ordPostcode}
			, ord_addr = #{ordAddr}
			, ord_detail = #{ordDetail}
		<where>
			AND ord_code = #{ordCode}
		</where>
	</update>

<!-- 	<select id="selectAllPrd" parameterType="BuyerLogin" resultType="AllPrd"> -->
		
<!-- 	</select> -->

	<select id="selectMyExpList" parameterType="recycling.util.Paging" resultType="Exp">
		SELECT * FROM (
			SELECT rownum rnum, E.* FROM (
				<include refid="selectExp"/>
				<where>
					AND exp_name LIKE '%' || #{search } || '%' 
						OR exp_code LIKE '%' || #{search } || '%' 
				</where>
				ORDER BY exp_code
			) E
		)
		<where>
			AND rnum BETWEEN #{startNo} AND #{endNo}
		</where>
	</select>
	
	
	<select id="selectCntAll" parameterType="string" resultType="int">
		SELECT count(*) FROM Exp
		<where>
			AND exp_name LIKE '%' || #{key } || '%' 
				OR exp_code LIKE '%' || #{search } || '%'
		</where>
		ORDER BY exp_date DESC
	</select>
	
	<select id="selectPageAll" resultType="int">
		SELECT COUNT(*) FROM (
			SELECT * FROM exp_res
			<where>
				AND sch_no = #{schNo}
			</where>
		)
	</select>
	
	<select id="selectByExp" parameterType="string" resultType="Exp">
		SELECT * FROM exp
		<where>
			AND exp_code = #{expCode}
		</where>
	</select>
	
<!-- 	<select id="selectResList" parameterType="recycling.util.Paging" resultType="ExpRes"> -->
<!-- 		<bind name="expCode" value="'#{expCode}'"/> -->
<!-- 		SELECT * FROM ( -->
<!-- 			SELECT rownum rnum, B.* FROM ( -->
<!-- 				SELECT er.* -->
<!-- 				FROM exp_res er -->
<!-- 				INNER JOIN exp_sch es ON er.SCH_NO = es.SCH_NO -->
<!-- 				INNER JOIN exp e ON es.exp_code = e.exp_code -->
<!-- 				WHERE e.exp_code = #{expCode} -->
<!-- 			) B -->
<!-- 		) -->
<!-- 		<where> -->
<!-- 			AND rnum BETWEEN #{startNo } AND #{endNo } -->
<!-- 		</where> -->
<!-- 	</select> -->
	<select id="selectResList" parameterType="string" resultType="ExpRes">
		SELECT er.*
		FROM exp_res er
		INNER JOIN exp_sch es ON er.sch_no = es.sch_no
		INNER JOIN exp e ON es.exp_code = e.exp_code
		<where>
			AND e.exp_code = #{expCode}
		</where>
	</select>

	<select id="selectCntAllupcyPrd" parameterType="recycling.util.PagingAndCtg" resultType="int">
		SELECT count(*) FROM prd
		<where>
			AND s_code = #{user }
			AND ct_pno = 1
			AND (
				prd_name LIKE '%' || #{search } || '%'
				OR prd_detail LIKE '%' || #{search } || '%'
				)
		</where>
		ORDER BY prd_code DESC
	</select>
</mapper>