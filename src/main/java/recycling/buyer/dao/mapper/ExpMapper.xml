<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="recycling.buyer.dao.face.ExpDao">

	<sql id="selectExp">
	SELECT * FROM Exp
	</sql>
	
	<select id="selectAllExp" parameterType="recycling.util.Paging" resultType="Exp">
		SELECT * FROM (
			SELECT rownum rnum, E.* FROM (
				<include refid="selectExp"/>
				<where>
					AND exp_name LIKE '%' || #{search } || '%' 
						OR exp_code LIKE '%' || #{search } || '%' 
				</where>
				ORDER BY exp_code
			) E
		)
		<where>
			AND rnum BETWEEN #{startNo} AND #{endNo}
		</where>
	</select>
	
	<select id="selectCntAll" parameterType="string" resultType="int">
		SELECT count(*) FROM Exp
		<where>
			AND exp_name LIKE '%' || #{key } || '%' 
				OR exp_code LIKE '%' || #{search } || '%'
		</where>
		ORDER BY exp_date DESC
	</select>
	
<!-- 	최신 체험단 조회 -->
	<select id="selectRecentExp" parameterType="recycling.util.Paging" resultType="exp">
        SELECT * FROM (
            SELECT rownum rnum, E.* FROM (
                <include refid="selectExp"/>
                <where>
                    AND exp_name LIKE '%' || #{search} || '%' 
                        OR exp_code LIKE '%' || #{search} || '%' 
                </where>
                ORDER BY exp_date DESC
            ) E
        )
        <where>
            AND rnum BETWEEN #{startNo} AND #{endNo}
        </where>
    </select>

    <!-- 인기 체험단 조회 -->
    <select id="selectPopularExp" parameterType="recycling.util.Paging" resultType="exp">
        SELECT * FROM (
            SELECT rownum rnum, E.* FROM (
                <include refid="selectExp"/>
                <where>
                    AND exp_name LIKE '%' || #{search} || '%' 
                        OR exp_code LIKE '%' || #{search} || '%' 
                </where>
                ORDER BY exp_hit DESC
            ) E
        )
        <where>
            AND rnum BETWEEN #{startNo} AND #{endNo}
        </where>
    </select>

    <!-- 상단 인기 체험 조회 -->
    <select id="selectTopPopExp" resultType="exp">
    	SELECT * FROM (
            SELECT rownum rnum, E.* FROM (
                <include refid="selectExp"/>
                ORDER BY exp_hit DESC
            ) E
        )
        WHERE rnum BETWEEN 1 AND 5
    </select>
    
    <!-- 상단 새체험 조회 -->
    <select id="selectTopRecExp" resultType="exp">
    	SELECT * FROM (
            SELECT rownum rnum, E.* FROM (
                <include refid="selectExp"/>
                ORDER BY exp_date DESC
            ) E
        )
        WHERE rnum BETWEEN 1 AND 5
    </select>
    
    <select id="selectByExpCode" resultType="Exp" parameterType="string">
    	SELECT * FROM Exp
    	<where>
    		AND exp_code = #{expCode}
    	</where>
    </select>
    
    <select id="selectByExpFile" resultType="ExpFile" parameterType="string">
    	SELECT * FROM exp_file
    	<where>
    		AND exp_code = #{expCode}
    	</where>
    </select>
	
	<select id="getSellerInfo" resultType="Seller" parameterType="string">
		SELECT * FROM Seller
		<where>
			AND s_code = #{sCode}
		</where>
	
	</select>
	
	<select id="getBuyerInfo" resultType="Buyer" parameterType="string">
		SELECT b.* FROM Buyer b 
			JOIN Seller s ON s.b_code = b.b_code
		<where>
			AND b.b_code = #{bCode}
		</where>
	
	</select>
	
	<update id="updateExpHit" parameterType="string">
		UPDATE Exp
			SET exp_hit = exp_hit + 1
		<where>
			AND exp_code = #{expCode }
		</where>
	</update>
	
	<select id="getBuyerDetail" parameterType="string" resultType="recycling.dto.buyer.Buyer">
		SELECT B_Code AS bCode,
		       B_Ct_Code AS bCtCode,
		       B_Id AS bId,
		       B_Pw AS bPw,
		       B_Name AS bName,
		       B_Phone AS bPhone,
		       B_Email AS bEmail,
		       Ad_Sms AS adSms,
		       Ad_Email AS adEmail
		FROM Buyer
		<where>
			AND B_Id = #{bId }
		</where>
	</select>
	
	<select id="getExpSchList" resultType="ExpSch" parameterType="string">
		SELECT * FROM exp_sch
		<where>
			AND exp_code = #{expCode}
		</where>
	</select>
	
	<select id="getExpSch" resultType="ExpSch" parameterType="int">
		SELECT * from exp_sch
		<where>
			AND sch_no = #{schNo}
		</where>
	</select>
	
	<insert id="insertExpRes" parameterType="ExpRes" useGeneratedKeys="true" keyProperty="resCode" keyColumn="res_code">
		INSERT INTO exp_res (
			res_code, 
			b_code, 
			sch_no, 
			res_name, 
			res_phone, 
			res_email, 
			res_expname, 
			res_date, 
			res_time, 
			res_cnt, 
			res_price, 
			res_sum, 
			res_pay, 
			pay_date,
			res_cnf,
			res_cnl,
			res_dt 
			) VALUES (
    		'RES' || lpad(exp_res_seq.nextval, 7, '0'), 
    		#{bCode}, 
    		#{schNo}, 
    		#{resName}, 
    		#{resPhone}, 
    		#{resEmail}, 
    		#{resExpName}, 
    		TO_DATE(#{resDate},'YYYY-MM-DD HH24:MI:SS'),
<!-- 			#{resDate}, -->
    		#{resTime}, 
    		#{resCnt}, 
    		#{resPrice}, 
    		#{resSum}, 
    		#{resPay}, 
    		SYSDATE, 
    		#{resCnf}, 
    		#{resCnl}, 
    		#{resDt}
    		)
	</insert>
	
	<update id="updateExpSchCnt" parameterType="map">
		UPDATE exp_sch
		SET sch_cnt = sch_cnt - (
			SELECT SUM(res_cnt)
			FROM exp_res
			<where>
				AND sch_no = #{schNo}
				AND res_date = #{resDate}
				AND res_time = #{resTime}
			</where>
		)
		<where>
			AND sch_no = #{schNo}
			AND sch_date = #{schDate}
			AND sch_time = #{schTime}
		</where>
	</update>
</mapper>